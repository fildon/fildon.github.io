<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Understanding React Dependency Arrays.</title>
		<meta name="description" content="DRY component logic and separation of rendering from state management.">
		<link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico">
		<link rel="stylesheet" href="/static/styles.css">
		<link rel="stylesheet" href="/static/prism.css">
		<meta
			property="og:description"
			content="DRY component logic and separation of rendering from state management."
		/>
		<meta
			property="og:image"
			content="https://raw.githubusercontent.com/fildon/train-ride/main/train-ride.png"
		/>
		<meta property="og:image:type" content="image/png" />
		<meta property="og:image:width" content="1280" />
		<meta property="og:image:height" content="640" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta property="twitter:domain" content="rupertmckay.com" />
		<meta property="twitter:url" content="https://rupertmckay.com" />
		<meta name="twitter:title" content="Understanding React Dependency Arrays." />
		<meta
			name="twitter:description"
			content="DRY component logic and separation of rendering from state management."
		/>
		<meta
			name="twitter:image"
			content="https://raw.githubusercontent.com/fildon/train-ride/main/train-ride.png"
		/>
	</head>
	<body>
		<header class="horizontal-spread">
			<img
				src="../../static/headshot.jpeg"
				alt="Headshot of Rupert"
				class="rounded wonky"
				height="64"
				width="64"
			/>
			<h1><a href="/">Rupert McKay</a></h1>
		</header>
		<section class="full-width banner">
			<div>
				<h2>About</h2>
				<p>
					I am Rupert Foggo McKay. I live and work in the Netherlands.
					I work at <a href="https://lokalise.com/">Lokalise.com</a> as a Staff Software Engineer.
					I write blog posts on esoteric topics from time to time.
				</p>
			</div>
			<address>
				<a href="/blog/">Blog</a>
				<a href="https://github.com/fildon/">GitHub</a>
				<a rel="me" href="https://strangeobject.space/@fildon">Masto</a>
				<a href="mailto:maxfmckay@gmail.com">Email</a>
				<a href="./feed.xml">RSS</a>
			</address>
		</section>
		<pre aria-hidden="true" class="morse">
█ ███ █
███ ███
</pre>
		<article>
	<h1>Understanding React Dependency Arrays.</h1>
	<span>Posted: <date datetime="Sun Jun 20 2021 00:00:00 GMT+0000 (Coordinated Universal Time)">20 Jun 2021</date></span>
	<p>Several of React's hooks take a 'dependency array' argument. In this post, I will talk about different ways to use dependency arrays and some common pitfalls.</p>
<h2 id="what-is-a-dependency-array" tabindex="-1"><a class="direct-link" href="#what-is-a-dependency-array" aria-hidden="true">#</a> What is a Dependency Array?</h2>
<p>Dependency arrays are how we tell React when to update a hook. Here are all the hooks that can take a dependency array:</p>
<ul>
<li>useEffect</li>
<li>useCallback</li>
<li>useMemo</li>
<li>useImperativeHandle</li>
<li>useLayoutEffect</li>
</ul>
<p>In each case, when React detects a change in any value of a dependency array, the given hook will update in some way. For example, <code>useEffect</code> will rerun its callback, whereas <code>useCallback</code> will recompute the memoized function it returns.</p>
<h2 id="typical-usage" tabindex="-1"><a class="direct-link" href="#typical-usage" aria-hidden="true">#</a> Typical Usage</h2>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  document<span class="token punctuation">.</span>title <span class="token operator">=</span> isLoggedIn <span class="token operator">?</span> <span class="token string">"✅ Welcome ✅"</span> <span class="token operator">:</span> <span class="token string">"⛔ Please Login ⛔"</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>isLoggedIn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In this example, we update the document title to indicate whether the current user is logged in. We don't want to run this effect on every render, only when the <code>isLoggedIn</code> value changes.</p>
<p>As a rule of thumb, you should include <em>every</em> value your callback depends on in the dependency array. The React team publish and maintain an <code>eslint</code> plugin to verify that you do this, I highly recommend it: <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks">eslint-plugin-react-hooks</a></p>
<h2 id="empty-array" tabindex="-1"><a class="direct-link" href="#empty-array" aria-hidden="true">#</a> Empty Array</h2>
<p>React will run all hooks the first time a component mounts, but by providing an empty array, we indicate to React that we never want our hook to rerun after that. This pattern is especially useful for simulating an &quot;on mount&quot; effect.</p>
<p>For example, suppose we have a timer, which counts each second:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oldVal<span class="token punctuation">)</span> <span class="token operator">=></span> oldVal <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>By providing an empty array here, we initialize our <code>setInterval</code> logic only once when the component first mounts. The interval will keep running as long as our component is mounted. We don't want to rerun this <code>useEffect</code> more than once, or else we would have multiple intervals running, each trying to update the same state. Note also that we pass a callback to <code>setCount</code> rather than need to depend on the current value of <code>count</code>. You can read more about this particular feature of <code>useState</code> in the React docs here: <a href="https://reactjs.org/docs/hooks-reference.html#functional-updates">Functional Updates</a></p>
<h2 id="omitting-the-dependency-array" tabindex="-1"><a class="direct-link" href="#omitting-the-dependency-array" aria-hidden="true">#</a> Omitting the Dependency Array</h2>
<p>If passing an empty array corresponds to never rerunning, then passing nothing at all corresponds to <em>rerunning on every render</em>.</p>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Rendered MyComponent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In this example, we write to our logger every time our component is rendered. I recommend doing this only very sparingly since in a typical React application this would produce an awful lot of noise in our logs. But I will occasionally do this when trying to measure how often a component rerenders.</p>
<hr>
<h2 id="common-pitfalls" tabindex="-1"><a class="direct-link" href="#common-pitfalls" aria-hidden="true">#</a> Common Pitfalls</h2>
<p>Now that we understand how to pass a dependency array, let's look at some common mistakes.</p>
<h3 id="object-references" tabindex="-1"><a class="direct-link" href="#object-references" aria-hidden="true">#</a> Object References</h3>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">displayWelcomeMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Here <code>user</code> is an object. React will detect that an object has changed <em>if and only if</em> its reference has changed. In this example, the user's name might have changed between renders, but the reference to <code>user</code> might not. If so the welcome message we want to display will continue to display old data even after the user has changed their name. To fix this, be specific about the values you depend on in your dependency array:</p>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">displayWelcomeMessage</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>user<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>lastName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="array-references" tabindex="-1"><a class="direct-link" href="#array-references" aria-hidden="true">#</a> Array References</h3>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">notifyUsers</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>users<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Here <code>users</code> is an array. As before, React will detect that an array has changed <em>if and only if</em> its reference has changed. In this example, that means that adding, removing, or modifying a user inside the <code>users</code> array will not cause the hook to fire. To fix this we can spread our array inside the dependency array:</p>
<pre class="language-ts"><code class="language-ts">React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">notifyUsers</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">...</span>users<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="function-references" tabindex="-1"><a class="direct-link" href="#function-references" aria-hidden="true">#</a> Function References</h3>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token function-variable function">postUserDataToServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=></span> api<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> onSignUp <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><br>  <span class="token punctuation">(</span>signUpFormData<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token function">postUserDataToServer</span><span class="token punctuation">(</span>signUpFormData<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">[</span>postUserDataToServer<span class="token punctuation">]</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>In this example <code>postUserDataToServer</code> is passed as a dependency to our <code>onSignUp</code> callback. Unfortunately, since <code>postUserDataToServer</code> is defined within the same component, it is redefined on every render, and hence is a new function on every render.</p>
<p>To fix this we can either memoize the function, or define it only inside the useCallback:</p>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> onSignUp <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>signUpFormData<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token function-variable function">postUserDataToServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">=></span> api<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">postUserDataToServer</span><span class="token punctuation">(</span>signUpFormData<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="0-vs-0" tabindex="-1"><a class="direct-link" href="#0-vs-0" aria-hidden="true">#</a> +0 vs -0</h3>
<p>According to both <code>==</code> and <code>===</code>, +0 and -0 are equal. Unfortunately, React uses <code>Object.is</code> to check for changes in a dependency array.</p>
<pre class="language-ts"><code class="language-ts"><span class="token number">0</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br><span class="token number">0</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br>Object<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre>
<p>If our dependency array includes a number that changes between +0 and -0, then our hook might fire more often than we want. Firing too often can impact performance, but is rarely a cause of bugs. Even so, it is good to be aware of this quirk, when it comes time to debug a hook that is firing at unexpected times.</p>
<h2 id="summary" tabindex="-1"><a class="direct-link" href="#summary" aria-hidden="true">#</a> Summary</h2>
<ul>
<li>Passing an empty array runs only on mount</li>
<li>Passing nothing runs on every render</li>
<li>Changes are detected with <code>Object.is</code></li>
</ul>

</article>
		<pre aria-hidden="true" class="morse">
█ ███ █
███ ███
</pre>
	</body>
</html>